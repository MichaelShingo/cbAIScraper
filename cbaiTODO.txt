CBYellow: #ffde59
customizable loading gif source: https://loading.io

- clean up scraping code
- map page should reload when user logs in via login button.
- add filtering to maps page. Maybe this should be separate from the databae page.

Database page tests
1. User is not logged in.
2. Logged in but has never saved an opportunity.
3. Logged in and has saved an opportunity.
- See saved opps button on repeater works 
- deleting opps works 
- See saved opps button at top works 
- Saved opps are marked across all pages of repeater.
- Lightbox shows up for ONLY unauthenticated users. 
- Lightbox "Create Account" button works 
- search by text works 
- filtering by type of opportunity works 
- Check everything on the mobile site! If issues, it's probably an element that's hidden with GUI that is also being selected in the code.

Clean up Database page
- can you do instant search on change? 
- and button to clear filters?  
- disable button while saving to database, then enable when done. 

Cases:
1. good - User has never saved an opp 
2. good - User has saved opps, but currently has nothing saved 
3. good - but tab activity slow - Active opp is saved, but archived is not 
4. good - Archived opp is saved, but active is not
5. good but slow tab activity - both types of opps are saved 
6. good - You delete active opps until there are none 
7. good - You delete archived opps until there are none
8. good - You delete all opps until there are none 

 
archived samples:  "128173b2-37ac-4ede-9460-e7c6b9b329c2","08ca18bc-dc6f-433f-8918-d395f3529411", "ccae931f-b59a-4255-b718-8ac3e2b8207a"

- read more button is there even when there is not more to read, may be unavoidable with wix's implementation of collaposible text combined with dynamic texts. 

Database New features 
- search auto-suggest  https://www.youtube.com/watch?v=TCLd5GIKlpA

- WHEN YOU REFRESH MY OPPS - page is unresponsive until this console log: utils.js:11 react-i18next:: It seems you are still using the old wait option, you may migrate to the new useSuspense behaviour.

- Let users indicate if they've applied or not 
	- you can do this with existing data structure if you add another field in the database 
	- it contains an array of booleans that correspond to each opportunity 
- let users flag an opp that is not free 
- when you go too fast on the main database page, it doesn't save stuff sometimes 
	- it's because it's not waiting for the previous one to finish? 
	- can you make the cursor pointer on hover heart? 
	- saved 
	
	
Additional scraping
- https://pickuptheflow.org - images 
- https://www.sphinxmusic.org/job-postings !!!!! doable now 
- League of American Orchestras - https://jobs.americanorchestras.org/jobs/19116133/annual-giving-coordinator


Map

- automatically add coordinates when opps are imported, 
- can the map display roman charcters for all countries? 
- amsterday, The Netherlands does not register 
- UX near the edges of the map are weird 

Next Major Map Update
 - when its grouping them together when your zoomed out, it feels like if I click that it should highlight a region and the pop up description on the side should display a list of all those opportunities, and any given opportunity would be highlighted if I hovered or clicked on the description in the list. And that you would be able to click on them individual also, the way it works now.


- user-submitted opportunities, can you get coordinates for those using a backend hook? In general can you use a hook to handle coordinate adding? 


beverly hills, san francisco, cincinatti missing 
- what if you put opp map on opp page and feed it whatever the filtered data is from the database? 










- Can you make the search function more refined ( why does searaching composer and composition how things that have nothing to do with it)?



SEVEARL OPPS WITH FEES SLIP THROUGH
Music Engraving & Editing Service - Stanley M. Hoffman - can you exclude this all the time? (list of banned opportunities)

Piano Scribe - should also be excluded 

Maybe don't go as far in composer site opps, because they're either repeated or low quality 

Some locations come with no comma - New York City, New York United States
Asian arts Alliance

ADmin Login:
mcraw
#m0n0AWARE or something 




import { fetch } from 'wix-fetch';
import wixData from 'wix-data';
import wixSecretsBackend from 'wix-secrets-backend';

const DATABASE_ID = 'testOpportunities';

export async function locationToCoordinates() {
    const forbiddenLocations = new Set(['Online', 'None', 'International']);
    const USERNAME = await wixSecretsBackend.getSecret('GEONAMES_USER');

    const formatLocation = (location) => {
        let res = '';
        try {
            if (location === 'USA') {
                res = 'United States';
            }
            res = location.replace(/ /g, '%20');
            res = res.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            console.log(`formattedLocation = ${res}`)
        } catch {
            console.log('error in formatLocation');
        }
        
        return res;
    }
    const query = await wixData.query(DATABASE_ID).limit(1000).find();
    console.log(`querylength = ${query.items.length}`);
    const items = query.items;
    for (let item of items) {
        console.log(item.location);
        if (forbiddenLocations.has(item.location)) {
            continue
        } else {
            try {
                let formattedLocation = formatLocation(item.location);
                console.log(formattedLocation);
                const url = `http://api.geonames.org/postalCodeSearchJSON?placename=${formattedLocation}&username=${USERNAME}`;
                const response = await fetch(url);
                const json = await response.json();
                if (json.postalCodes.length === 0) {
                    continue
                }
                const firstObject = json.postalCodes[0];
                console.log(firstObject);
                console.log(firstObject.lat, firstObject.lng);
                item.lat = firstObject.lat.toFixed(7);
                item.lng = firstObject.lng.toFixed(7);

                // check if lat/lng already exist
                

            } catch {
                continue;
            }
            
        }
        
        
        const updateResult = await wixData.update(DATABASE_ID, item);
        console.log('updated')
        
    }
}





// const prefetchRes = wixSiteFrontend.prefetchPageResources( {
    //     "pages": ['account/my-opportunities']
    // } );
	
	
	
	
	wixData.query(USER_OPPORTUNITIES)
                        .eq("memberID", currentUserID)
                        .find()
                        .then((results) => {
                            let opportunityArray = results.items[0].opportunityIDs;
                            let removeIndex = opportunityArray.indexOf(itemData._id);
                            if (results.items.length > 0 && removeIndex > -1){                                  
                                opportunityArray.splice(removeIndex, 1);
                                let currentDatabaseID = results.items[0]._id;
                                wixData.get(USER_OPPORTUNITIES, currentDatabaseID)
                                    .then((item) => {
                                        let toUpdate = item;
                                        toUpdate.opportunityIDs = opportunityArray;
                                        wixData.update(USER_OPPORTUNITIES, toUpdate)
                                            .then((results) => {
                                                
                                            })
                                            .catch((err) => {
                                                console.log(err);
                                            });
                                    });
                            }
                        });
						
					




					
						
						
					debounceTimer set Time out 
					
					   //$w("#dataset1").setFilter(wixData.filter().contains("title", $w('#searchBar').value)
        //    .or(wixData.filter().contains("notes", $w('#searchBar').value)).ge("dueDate", today)).then(() => {
        //    count();
        //})
		
		
		
		
		
		
		
	const runSearch = () => {
    let word = $w("#searchBar").value;
    local.setItem("searchWord", word);
    // wixLocation.to(`/hotelresultpage`);
}

export function vectorImage1_click(event) {
    runSearch();
}